# 2026-02-25 実装ログ

## 概要

`~/.claude/rules/` のセキュリティ・ベンダーロック回避ルールに基づくリファクタリングを実施。
Repository層の導入・セキュリティ修正・Storage管理方式の改善が主な内容。

---

## Phase 1 — セキュリティ修正

### 1-1. LBank署名ログ削除（`lib/lbank/api.ts`）

| 項目 | 内容 |
|------|------|
| 問題 | `buildSignature()` 内で署名値・MD5・sorted string を `console.log` 出力していた |
| 対応 | 5行削除（`security-baseline.md` § 1.1 違反） |

### 1-2. PATCH ホワイトリスト化（`app/api/cups/[id]/route.ts`）

| 項目 | 内容 |
|------|------|
| 問題 | `update(body)` でリクエストボディを無検証で全フィールド渡していた |
| 対応 | `ALLOWED_PATCH_FIELDS` を定義し、許可外フィールドを無視 |
| 許可フィールド | `name` / `description` / `start_at` / `end_at` / `status` / `min_balance_usdt` / `min_volume_usdt` / `rewards` / `cover_image_url` |

### 1-3. Admin 失格処理の API 化（`app/admin/cups/[id]/page.tsx`）

| 項目 | 内容 |
|------|------|
| 問題 | フロントエンドから `supabase.from('cup_participants').update(...)` を直呼び出し |
| 対応 | `POST /api/admin/cups/[id]/disqualify` を新規作成、フロントは `fetch` 経由に変更 |
| 新規ファイル | `app/api/admin/cups/[id]/disqualify/route.ts` |
| ガード内容 | 管理者 auth チェック / cup 帰属チェック（`participant.cup_id !== cupId`）/ 二重失格防止 |

---

## Phase 2 — Repository 層の導入

### 背景

全 API ルートが `supabase.from(...)` を直呼び出しする構造だったため、
`vendor-lockin-avoidance.md` の「Repository 層に集約」ルールに違反していた。

### 新規作成ファイル

| ファイル | 提供するメソッド |
|---------|----------------|
| `lib/repositories/cup.ts` | `findAll` / `findById` / `create` / `update` / `delete` / `countParticipants` |
| `lib/repositories/cup-participant.ts` | `findById` / `findByUser` / `findByCup` / `findByCupAll` / `findByCupWithApiKeys` / `create` / `disqualify` / `updateStats` / `updateRank` / `saveSnapshot` |
| `lib/repositories/exchange-api-key.ts` | `findByUser` / `findStatusByUser` / `upsert` |
| `lib/storage/index.ts` | `uploadCupCover` / `getCupCoverUrl`（object_key 管理） |

### 更新した API ルート（8 ファイル）

- `app/api/cups/route.ts`
- `app/api/cups/[id]/route.ts`
- `app/api/cups/[id]/register/route.ts`
- `app/api/cups/[id]/cover-image/route.ts`
- `app/api/cups/[id]/ranking/route.ts`
- `app/api/lbank/status/route.ts`
- `app/api/lbank/save-key/route.ts`
- `app/api/cron/ranking/route.ts`

---

## Phase 3 — Storage URL → Object Key 移行

### 背景

`cover_image_url` に Supabase Storage の Public URL を直保存していたため、
`vendor-lockin-avoidance.md` § 2.2「DBに Storage URL を保存しない」ルールに違反。

### 対応内容

| 項目 | 内容 |
|------|------|
| `supabase/migrations/003_cover_image_key.sql` | `cover_image_key TEXT` カラム追加・既存データを移設 |
| `types/database.ts` | `cover_image_key: string \| null` フィールド追加 |
| `lib/storage/index.ts` | アップロード → object_key 返却、URL は `getCupCoverUrl()` で都度生成 |
| `app/api/cups/[id]/cover-image/route.ts` | `cover_image_key` と `cover_image_url`（互換）の両方に保存 |

### マイグレーション適用状況

- Supabase ダッシュボード SQL Editor から手動適用済み（2026-02-25）
- Supabase CLI 未連携のため migration 追跡テーブルへの記録なし（冪等な SQL のため再実行時も安全）

---

## 未対応（Phase 4 / 別途設計議論が必要）

| 項目 | 内容 |
|------|------|
| `app/api/cron/ranking/route.ts` の PNL 直 UPDATE | `pnl` / `pnl_pct` のキャッシュ更新は継続しているが、`cup_snapshots` をイベントソースとして扱う設計への移行は未着手 |
| 参照先ルール | `ledger-and-reconciliation.md` § 1.3「残高は結果として扱う」 |
| 対応方針 | スナップショットから再計算する集計ロジックへの変更（別 PR で設計レビュー後に実施） |

---

## コミット

```
a3f1c49  refactor: Repository層導入・セキュリティ修正・Storage object_key移行
```
